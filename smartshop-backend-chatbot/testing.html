<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartShop Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 10px;
        }

        .header h1 {
            color: #63b3ed;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .debug-panel {
            background: #2d3748;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #4a5568;
        }

        .panel-title {
            color: #63b3ed;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            color: #a0aec0;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.2);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #3182ce, #2b6cb0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(49, 130, 206, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d69e2e, #b7791f);
        }

        .output-panel {
            grid-column: 1 / -1;
            background: #1a202c;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #4a5568;
            max-height: 600px;
            overflow-y: auto;
        }

        .output-content {
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .log-info {
            background: rgba(99, 179, 237, 0.1);
            border-left: 3px solid #63b3ed;
        }

        .log-success {
            background: rgba(56, 161, 105, 0.1);
            border-left: 3px solid #38a169;
        }

        .log-warning {
            background: rgba(214, 158, 46, 0.1);
            border-left: 3px solid #d69e2e;
        }

        .log-error {
            background: rgba(229, 62, 62, 0.1);
            border-left: 3px solid #e53e3e;
        }

        .quick-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .test-btn {
            padding: 8px 12px;
            font-size: 12px;
            background: #4a5568;
            border: 1px solid #718096;
        }

        .test-btn:hover {
            background: #2d3748;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-online {
            background: #38a169;
        }

        .status-offline {
            background: #e53e3e;
        }

        .json-viewer {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .json-key {
            color: #63b3ed;
        }

        .json-string {
            color: #68d391;
        }

        .json-number {
            color: #fbb6ce;
        }

        .json-boolean {
            color: #fbd38d;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #2d3748;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #4a5568;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #63b3ed;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #a0aec0;
        }

        @media (max-width: 768px) {
            .debug-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è SmartShop Debug Tool</h1>
            <p>Test v√† debug h·ªá th·ªëng search AI</p>
            <div>
                <span id="serverStatus" class="status-indicator status-offline"></span>
                <span id="serverStatusText">Checking server...</span>
            </div>
        </div>

        <div class="debug-grid">
            <!-- Search Testing Panel -->
            <div class="debug-panel">
                <div class="panel-title">üîç Search Testing</div>
                
                <div class="input-group">
                    <label class="input-label">Query to test:</label>
                    <input type="text" class="input-field" id="testQuery" 
                           placeholder="iPhone d∆∞·ªõi 20 tri·ªáu" value="iPhone d∆∞·ªõi 20 tri·ªáu">
                </div>

                <div class="input-group">
                    <label class="input-label">Additional Filters (JSON):</label>
                    <textarea class="input-field" id="testFilters" 
                              placeholder='{"brand": "Apple", "maxPrice": 20000000}'></textarea>
                </div>

                <div>
                    <button class="btn" onclick="testSingleQuery()">üîç Test Query</button>
                    <button class="btn btn-warning" onclick="testMultipleQueries()">üìä Batch Test</button>
                </div>

                <div class="quick-tests">
                    <button class="test-btn" onclick="quickTest('iPhone gi√° r·∫ª')">iPhone gi√° r·∫ª</button>
                    <button class="test-btn" onclick="quickTest('Samsung pin tr√¢u')">Samsung pin tr√¢u</button>
                    <button class="test-btn" onclick="quickTest('gaming phone')">Gaming phone</button>
                    <button class="test-btn" onclick="quickTest('ƒëi·ªán tho·∫°i ch·ª•p ·∫£nh ƒë·∫πp')">Camera ƒë·∫πp</button>
                    <button class="test-btn" onclick="quickTest('h·ªçc sinh sinh vi√™n')">Sinh vi√™n</button>
                    <button class="test-btn" onclick="quickTest('ng∆∞·ªùi gi√†')">Ng∆∞·ªùi gi√†</button>
                </div>
            </div>

            <!-- API Testing Panel -->
            <div class="debug-panel">
                <div class="panel-title">üîß API Testing</div>
                
                <div class="input-group">
                    <label class="input-label">API Endpoint:</label>
                    <select class="input-field" id="apiEndpoint">
                        <option value="/api/chat">Chat Search</option>
                        <option value="/api/search">Advanced Search</option>
                        <option value="/api/compare">Compare Products</option>
                        <option value="/api/recommendations">Recommendations</option>
                        <option value="/api/brands">Get Brands</option>
                        <option value="/test">Server Test</option>
                        <option value="/health">Health Check</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">Request Body (JSON):</label>
                    <textarea class="input-field" id="requestBody" 
                              placeholder='{"message": "iPhone d∆∞·ªõi 20 tri·ªáu"}'></textarea>
                </div>

                <div>
                    <button class="btn" onclick="testAPI()">üöÄ Test API</button>
                    <button class="btn btn-success" onclick="testAllEndpoints()">üß™ Test All</button>
                    <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Clear</button>
                </div>
            </div>
        </div>

        <!-- Metrics Panel -->
        <div class="debug-panel">
            <div class="panel-title">üìä Performance Metrics</div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalRequests">0</div>
                    <div class="metric-label">Total Requests</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgResponseTime">0ms</div>
                    <div class="metric-label">Avg Response Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalProducts">0</div>
                    <div class="metric-label">Products Found</div>
                </div>
            </div>
            
            <div>
                <button class="btn btn-warning" onclick="runPerformanceTest()">‚ö° Performance Test</button>
                <button class="btn" onclick="resetMetrics()">üîÑ Reset Metrics</button>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <div class="panel-title">üìã Debug Output</div>
            <div id="debugOutput" class="output-content">
                <div class="log-info">üöÄ SmartShop Debug Tool Ready</div>
                <div class="log-info">üí° Start by testing a search query or API endpoint</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let metrics = {
            totalRequests: 0,
            successfulRequests: 0,
            totalResponseTime: 0,
            totalProducts: 0
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkServerStatus();
            updateRequestBodyPlaceholder();
            
            // Update request body when endpoint changes
            document.getElementById('apiEndpoint').addEventListener('change', updateRequestBodyPlaceholder);
        });

        function updateRequestBodyPlaceholder() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const requestBody = document.getElementById('requestBody');
            
            const examples = {
                '/api/chat': '{"message": "iPhone d∆∞·ªõi 20 tri·ªáu"}',
                '/api/search': '{"brand": "Samsung", "minPrice": 10000000, "maxPrice": 20000000}',
                '/api/compare': '{"productIds": [1, 6, 10]}',
                '/api/recommendations': '{"budget": 15000000, "userProfile": "student"}',
                '/api/brands': '{}',
                '/test': '{}',
                '/health': '{}'
            };
            
            requestBody.placeholder = examples[endpoint] || '{}';
            if (!requestBody.value.trim()) {
                requestBody.value = examples[endpoint] || '{}';
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    document.getElementById('serverStatus').className = 'status-indicator status-online';
                    document.getElementById('serverStatusText').textContent = 'Server Online';
                    log('‚úÖ Server is online and healthy', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('serverStatus').className = 'status-indicator status-offline';
                document.getElementById('serverStatusText').textContent = 'Server Offline';
                log(`‚ùå Server offline: ${error.message}`, 'error');
            }
        }

        function log(message, type = 'info') {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('debugOutput').innerHTML = '';
            log('üóëÔ∏è Debug output cleared', 'info');
        }

        async function testSingleQuery() {
            const query = document.getElementById('testQuery').value.trim();
            if (!query) {
                log('‚ùå Please enter a query to test', 'error');
                return;
            }

            log(`üîç Testing query: "${query}"`, 'info');
            
            const startTime = Date.now();
            try {
                let filters = {};
                const filtersText = document.getElementById('testFilters').value.trim();
                if (filtersText) {
                    try {
                        filters = JSON.parse(filtersText);
                    } catch (e) {
                        log(`‚ö†Ô∏è Invalid filters JSON, using empty filters`, 'warning');
                    }
                }

                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: query, filters })
                });

                const responseTime = Date.now() - startTime;
                updateMetrics(responseTime, response.ok);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Query successful (${responseTime}ms)`, 'success');
                    log(`üì± Found ${data.products.length} products`, 'info');
                    log(`ü§ñ AI Response: ${data.response}`, 'info');
                    
                    if (data.analysis) {
                        log(`üîç Analysis: ${JSON.stringify(data.analysis, null, 2)}`, 'info');
                    }
                    
                    if (data.products.length > 0) {
                        log(`üìã Top 3 results:`, 'info');
                        data.products.slice(0, 3).forEach((product, idx) => {
                            log(`  ${idx+1}. ${product.name} - ${product.price.toLocaleString()}‚Ç´ (${product.rating}‚≠ê)`, 'info');
                        });
                    }

                    metrics.totalProducts += data.products.length;
                    updateMetricsDisplay();
                } else {
                    const error = await response.text();
                    log(`‚ùå Query failed: ${error}`, 'error');
                }

            } catch (error) {
                const responseTime = Date.now() - startTime;
                updateMetrics(responseTime, false);
                log(`üí• Request failed: ${error.message}`, 'error');
            }
        }

        async function quickTest(query) {
            document.getElementById('testQuery').value = query;
            await testSingleQuery();
        }

        async function testMultipleQueries() {
            const queries = [
                "iPhone d∆∞·ªõi 20 tri·ªáu",
                "Samsung pin tr√¢u",
                "ƒëi·ªán tho·∫°i ch·ª•p ·∫£nh ƒë·∫πp",
                "gaming phone cao c·∫•p",
                "Xiaomi gi√° r·∫ª",
                "h·ªçc sinh sinh vi√™n",
                "OPPO selfie ƒë·∫πp",
                "ng∆∞·ªùi gi√† d√πng"
            ];

            log(`üìä Starting batch test with ${queries.length} queries`, 'info');
            
            for (let i = 0; i < queries.length; i++) {
                log(`\n--- Test ${i+1}/${queries.length} ---`, 'info');
                document.getElementById('testQuery').value = queries[i];
                await testSingleQuery();
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log(`\nüéâ Batch test completed!`, 'success');
        }

        async function testAPI() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const bodyText = document.getElementById('requestBody').value.trim();
            
            log(`üöÄ Testing API: ${endpoint}`, 'info');
            
            const startTime = Date.now();
            try {
                let requestOptions = {
                    method: endpoint === '/test' || endpoint === '/health' || endpoint === '/api/brands' ? 'GET' : 'POST',
                    headers: { 'Content-Type': 'application/json' }
                };

                if (requestOptions.method === 'POST' && bodyText) {
                    try {
                        JSON.parse(bodyText); // Validate JSON
                        requestOptions.body = bodyText;
                    } catch (e) {
                        log(`‚ùå Invalid JSON in request body`, 'error');
                        return;
                    }
                }

                const response = await fetch(`${API_BASE}${endpoint}`, requestOptions);
                const responseTime = Date.now() - startTime;
                updateMetrics(responseTime, response.ok);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API call successful (${responseTime}ms)`, 'success');
                    
                    // Format and display response
                    const formatted = JSON.stringify(data, null, 2);
                    if (formatted.length > 1000) {
                        log(`üìÑ Response (truncated): ${formatted.substring(0, 1000)}...`, 'info');
                    } else {
                        log(`üìÑ Response: ${formatted}`, 'info');
                    }
                } else {
                    const error = await response.text();
                    log(`‚ùå API call failed: ${error}`, 'error');
                }

            } catch (error) {
                const responseTime = Date.now() - startTime;
                updateMetrics(responseTime, false);
                log(`üí• API request failed: ${error.message}`, 'error');
            }
        }

        async function testAllEndpoints() {
            const endpoints = [
                { endpoint: '/health', method: 'GET', body: null },
                { endpoint: '/test', method: 'GET', body: null },
                { endpoint: '/api/brands', method: 'GET', body: null },
                { endpoint: '/api/chat', method: 'POST', body: '{"message": "iPhone test"}' },
                { endpoint: '/api/search', method: 'POST', body: '{"brand": "Apple"}' },
                { endpoint: '/api/compare', method: 'POST', body: '{"productIds": [1, 2]}' },
                { endpoint: '/api/recommendations', method: 'POST', body: '{"budget": 15000000}' }
            ];

            log(`üß™ Testing all ${endpoints.length} endpoints`, 'info');
            
            for (let i = 0; i < endpoints.length; i++) {
                const test = endpoints[i];
                log(`\n--- Testing ${test.endpoint} (${i+1}/${endpoints.length}) ---`, 'info');
                
                const startTime = Date.now();
                try {
                    const requestOptions = {
                        method: test.method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    
                    if (test.body) {
                        requestOptions.body = test.body;
                    }

                    const response = await fetch(`${API_BASE}${test.endpoint}`, requestOptions);
                    const responseTime = Date.now() - startTime;
                    updateMetrics(responseTime, response.ok);

                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ ${test.endpoint} - OK (${responseTime}ms)`, 'success');
                        
                        // Log key info based on endpoint
                        if (test.endpoint === '/api/chat' && data.products) {
                            log(`  üì± Found ${data.products.length} products`, 'info');
                        } else if (test.endpoint === '/api/brands' && data.brands) {
                            log(`  üè∑Ô∏è Found ${data.brands.length} brands`, 'info');
                        } else if (test.endpoint === '/api/search' && data.products) {
                            log(`  üîç Search returned ${data.products.length} products`, 'info');
                        }
                    } else {
                        log(`‚ùå ${test.endpoint} - Failed (${response.status})`, 'error');
                    }

                } catch (error) {
                    updateMetrics(Date.now() - startTime, false);
                    log(`üí• ${test.endpoint} - Error: ${error.message}`, 'error');
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            log(`\nüéâ All endpoint tests completed!`, 'success');
        }

        async function runPerformanceTest() {
            const testQueries = [
                "iPhone",
                "Samsung pin tr√¢u", 
                "ƒëi·ªán tho·∫°i ch·ª•p ·∫£nh ƒë·∫πp d∆∞·ªõi 15 tri·ªáu",
                "Xiaomi gaming phone cao c·∫•p",
                "OPPO selfie camera t·ªët cho sinh vi√™n"
            ];

            log(`‚ö° Starting performance test with ${testQueries.length} queries`, 'info');
            
            const results = [];
            const overallStart = Date.now();

            for (let i = 0; i < testQueries.length; i++) {
                const query = testQueries[i];
                const startTime = Date.now();
                
                try {
                    const response = await fetch(`${API_BASE}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: query })
                    });
                    
                    const responseTime = Date.now() - startTime;
                    const data = response.ok ? await response.json() : null;
                    
                    results.push({
                        query,
                        success: response.ok,
                        responseTime,
                        productsFound: data?.products?.length || 0,
                        serverTime: data?.processingTime || 0
                    });
                    
                    updateMetrics(responseTime, response.ok);
                    
                } catch (error) {
                    results.push({
                        query,
                        success: false,
                        responseTime: Date.now() - startTime,
                        error: error.message
                    });
                }
            }

            const totalTime = Date.now() - overallStart;
            const avgTime = totalTime / testQueries.length;
            const successRate = (results.filter(r => r.success).length / results.length * 100).toFixed(1);

            log(`\nüìä Performance Test Results:`, 'success');
            log(`‚è±Ô∏è Total Time: ${totalTime}ms`, 'info');
            log(`üìà Average per Query: ${avgTime.toFixed(2)}ms`, 'info');
            log(`‚úÖ Success Rate: ${successRate}%`, 'info');
            
            results.forEach((result, idx) => {
                const status = result.success ? '‚úÖ' : '‚ùå';
                log(`${status} "${result.query}" - ${result.responseTime}ms${result.productsFound ? ` (${result.productsFound} products)` : ''}`, 
                    result.success ? 'success' : 'error');
            });

            updateMetricsDisplay();
        }

        function updateMetrics(responseTime, success) {
            metrics.totalRequests++;
            metrics.totalResponseTime += responseTime;
            if (success) {
                metrics.successfulRequests++;
            }
        }

        function updateMetricsDisplay() {
            document.getElementById('totalRequests').textContent = metrics.totalRequests;
            document.getElementById('successRate').textContent = 
                metrics.totalRequests > 0 ? 
                ((metrics.successfulRequests / metrics.totalRequests) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('avgResponseTime').textContent = 
                metrics.totalRequests > 0 ? 
                (metrics.totalResponseTime / metrics.totalRequests).toFixed(0) + 'ms' : '0ms';
            document.getElementById('totalProducts').textContent = metrics.totalProducts;
        }

        function resetMetrics() {
            metrics = {
                totalRequests: 0,
                successfulRequests: 0,
                totalResponseTime: 0,
                totalProducts: 0
            };
            updateMetricsDisplay();
            log('üîÑ Metrics reset', 'info');
        }

        // Auto-refresh server status every 30 seconds
        setInterval(checkServerStatus, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        testSingleQuery();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLogs();
                        break;
                    case 'r':
                        e.preventDefault();
                        checkServerStatus();
                        break;
                }
            }
        });

        // Add some helpful tooltips
        log('üí° Keyboard shortcuts:', 'info');
        log('  Ctrl+Enter: Test current query', 'info');
        log('  Ctrl+L: Clear logs', 'info');
        log('  Ctrl+R: Refresh server status', 'info');
    </script>
</body>
</html>